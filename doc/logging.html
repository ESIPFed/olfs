<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Hyrax: Servlet Logging</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<STYLE>
<!--
H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#527CC1;font-size:22px;}
H2 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#527CC1;font-size:16px;}
H3 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#527CC1;font-size:14px;}
BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;}
B {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#527CC1;}
P {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}
PRE {font-family:"Courier New", Courier, mono;background:white;color:black;font-size:12px;}
A {color : black;}
A.name {color : black;}
HR {color : #525D76;}
.rightBanner {
	left: 100px;
}
LI {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}
.style3 {font-size: 10px}
.style4 {font-size: 14px}
.style5 {font-family: "Courier New", Courier, mono}
-->
</STYLE>
</head>

<body>
<a href="http://www.opendap.org"><img src="images/logo.gif" width="206" height="93" border="0"></a>
<h1 align="left">Logging Configuration <br>
<span class="style4">Hyrax <span class="style3">(version: beta-1.5)</span></span></h1>
<hr size="1" noshade="noshade">
<h4>Synopsis</h4>
<p>We see logging activities falling into two categories: </p>
<ul>
  <li><strong><a href="#Access">Access Logging</a></strong> - Is used to monitor server usage, server performance, and to see which resources are receiving the most attention. Tomcat has a very nice built in Access Logging mechanism, all you have to do is <a href="#Access">turn it on</a>.<br>
      <br>
    <br>
  </li>
  <li> <strong><a href="#Debug">Informational and debug logging</a></strong> - Most developers (myself included) rely on a collection of imbedded &quot;instrumentation&quot; that allows them to monitor their code and see what parts are being executed. Typically we like to design this instrumentation so that it can be enabled/disabled at runtime. Hyrax utilizes this type of debugging instrumentation. Although Hyrax but ships with it disabled, it can be enabled. If you were to encounter an internal problem with Hyrax we would have you enable different aspects of the instrumentation at your site so that we could review the output to determine the issue. </li>
</ul>
<p>&nbsp;</p>
<h1><a name="Access"></a>Access Logging </h1>
<p>Many people will want to record access logs for their Hyrax server. <strong>We</strong> want you to keep access logs for your Hyrax server.
 The easiest way to get a simple access log for Hyrax is to utilize the Tomcat/Catalina implementation of the 
<a href="http://tomcat.apache.org/tomcat-5.0-doc/catalina/docs/api/org/apache/catalina/valves/AccessLogValve.html">org.apache.catalina.valves.AccessLogValve</a> class. </p>
<h2><strong>AccessLogValve</strong></h2>
<p>Since Hyrax's public facade is provided by the OLFS running inside of the Tomcat servlet container you may utilize Tomcat's handy access logging which relies on the <a href="http://tomcat.apache.org/tomcat-5.0-doc/catalina/docs/api/org/apache/catalina/valves/AccessLogValve.html">org.apache.catalina.valves.AccessLogValve</a> class. By default Tomcat comes with this turned off. </p>
<p>To turn it on:</p>
<ol>
  <li>Locate the file <em>$CATALINA_HOME/conf/servlet.html.</em> </li>
  <li>Find the commented out section for the access log inside the <span class="style5">&lt;Host&gt;</span> element. The server.xml file contains a good deal of comments, both for instruction and containing code examples. The part you are looking for is nested inside of the <span class="style5">&lt;Service&gt;</span> and the <span class="style5">&lt;Engine&gt;</span> elements. Typically it will look like:<br>
  <pre>
&lt;Service ...&gt;
    .
    .
    .
    &lt;Engine...&gt;
        .
        .
        .
        &lt;Host name=&quot;localhost&quot; appBase=&quot;webapps&quot;
            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;
            xmlValidation=&quot;false&quot; xmlNamespaceAware=&quot;false&quot;&gt;
			.
			.
			.			
            &lt;!-- Access log processes all requests for this virtual host.  
                 By default, log files are created in the &quot;logs&quot; 
                 directory relative to $CATALINA_HOME.  If you wish, you can 
                 specify a different directory with the &quot;directory&quot;
                 attribute.  Specify either a relative (to $CATALINA_HOME) 
                 or absolute path to the desired directory. --&gt;
				 
            &lt;!--
            &lt;Valve className="org.apache.catalina.valves.AccessLogValve" 
                   directory="logs"  prefix="localhost_access_log." suffix=".txt"
                   pattern="common" resolveHosts="false"/&gt;  
            --/&gt;
            .
            .
            .
        &lt;/Host&gt;
        .
        .
        .
    &lt;/Engine&gt;
    .
    .
    .
&lt;/Service&gt;</pre>
  You can uncomment the &lt;Valve&gt; element to enable it and you 
  can change the values of the various attributes to suite your localization. For example:<br>
    <br>
    <br>
    <br>
	
	
	
<pre>
            &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; 
                   directory=&quot;logs&quot;  
                   prefix=&quot;access_log.&quot; 
                   suffix=&quot;.log&quot; 
                   pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b %D&quot;
                   resolveHosts=&quot;false&quot;/&gt;<br>
  </pre></li>
  <li>Save the file.<br>
    <br>
  </li>
  <li>Restart Tomcat.<br>
    <br>
  </li>
  <li>Go read yer log files!  <br>
  </li>
</ol>
<p>&nbsp;</p>
<p>Of note is the <em>pattern</em> attribute which allows you to customize the content of the access log entries. <br>
  It is documented in the <a href="http://tomcat.apache.org/tomcat-5.0-doc/catalina/docs/api/index.html">javadocs for Tomcat/Catalina</a>, as part of the <a href="http://tomcat.apache.org/tomcat-5.0-doc/catalina/docs/api/org/apache/catalina/valves/AccessLogValve.html">org.apache.catalina.valves.AccessLogValve</a> class. The pattern shown above will provide log output that looks like this:<br>
</p>
<pre>
        69.59.200.52 - - [05/Mar/2007:16:29:14 -0800] &quot;GET /opendap/data/nc/contents.html HTTP/1.1&quot; 200 13014 234
        69.59.200.52 - - [05/Mar/2007:16:29:14 -0800] &quot;GET /opendap/docs/images/logo.gif HTTP/1.1&quot; 200 8114 2
        69.59.200.52 - - [05/Mar/2007:16:29:51 -0800] &quot;GET /opendap/data/nc/TestPatDbl.nc.html HTTP/1.1&quot; 200 11565 137
        69.59.200.52 - - [05/Mar/2007:16:29:56 -0800] &quot;GET /opendap/data/nc/data.nc.ddx HTTP/1.1&quot; 200 2167 121
</pre>
<p>Where the last column is the time in milliseconds it took to service the request and the next to the last column is the number of bytes returned. <br>
</p>
<h1><a name="Debug"></a> Informational and Debug Logging Using Log4j </h1>
<p>In general you shouldn't have to modify the default logging configuration for Hyrax. It may become necessary, if you encounter problems, but otherwise I suggest you leave it be. </p>
<p>Having said that: Hyrax uses the Log4j logging package to provide an easily configurable and flexible logging environment. All &quot;console&quot; output is routed through the Log4j package and can be controlled using the Log4j configuration file. </p>
<p>There are several logging levels available: </p>
<ul>
  <li><strong>TRACE</strong></li>
  <li><strong>DEBUG</strong></li>
  <li><strong> INFO </strong></li>
  <li><strong>WARN</strong></li>
  <li><strong>ERROR</strong></li>
  <li><strong>FATAL</strong></li>
</ul>
<p>Hyrax ships with a default logging level of <strong>ERROR</strong>. </p>
<p>Additionally Hyrax maintains it's own access log using Log4j .</p>
<p><span class="style4">I strongly recommend that you take the time to <a href="http://logging.apache.org/log4j/docs/manual.html"><strong>read about Log4j</strong></a> before you attempt to manipulate the Log4j configuration. </span></p>
<h3>Configuration File Location </h3>
<p>Log4j gets it's configuration from an XML file. Hyrax locates  this file in the following manner:</p>
<ol>
  <li>Checks the &lt;init-parameter&gt; list for the hyrax servlet (in the web.xml) for a an &lt;init-parameter&gt; called &quot;log4j-init-file&quot;. If found, the value of this parameter is assumed to be a fully qualified path name for the file. This can be used to specify alternate Log4j config files. Note that this configuration will not be persistent across new installations of Hyrax.<br>
    <br>
  </li>
  <li>Failing 1, Hyrax then checks in the persistent content directory (<em>$TOMCAT_HOME/content/opendap</em>) for the file &quot;log4j.xml&quot;. If this file is present then it will be used to configure logging, and new installations of Hyrax will detect ad use this logging configuration automatically. <br>
    <br>
  </li>
  <li>Failing 2, Hyrax falls back to the log4j.xml file shipped with the distribution which is located in the <em>$TOMCAT_HOME/webapps/opendap/WEB-INF</em> directory. Changes made to this file will be lost when a new version of Hyrax is installed. </li>
</ol>
<p>&nbsp;</p>
<p>So - if you want to customize your Hyrax logging and have it be persistent, do it by copying the file:</p>
<blockquote>
  <p> <em>$TOMCAT_HOME/webapps/opendap/WEB-INF</em><em>/l</em><em>og4j.xml</em> </p>
</blockquote>
<p>to:</p>
<blockquote>
  <p><em>$TOMCAT_HOME/content/opendap/log4j.xml</em> </p>
</blockquote>
<p>And make your changes to the copy. . </p>
<h3>Configuration</h3>
<p>Did you <a href="http://logging.apache.org/log4j/docs/manual.html">read about Log4j</a>? Great! Let's get started... </p>
<p>There are a number of Appenders defined in the Hyrax log4j.xml file:</p>
<ul>
  <li><strong>stdout</strong> - Loggers using this Appender will send everything to the console/stdout - which in a Tomcat environment will get shunted into the file <em>$TOMCAT_HOME/logs/catalina.out</em></li>
  <li><strong>devNull</strong> - Loggers using this Appender will not log. All messages will be discarded. This is the Log4j equivalent of piping your output into <em>/dev/null</em> in a UNIX environment. </li>
  <li><strong>ErrorLog</strong> - Loggers using this Appender will have their log output placed in the error log file in the persistent content directory: <em>$TOMCAT_HOME/content/opendap/logs/error.log</em></li>
  <li><strong>HyraxAccessLog</strong> - Loggers using this Appender will have their log output placed in the access log file in the persistent content directory: <em>$TOMCAT_HOME/content/opendap/logs/HyraxAccess.log</em></li>
</ul>
<p>The default configuration pushes <strong>error</strong> level (and higher) messages into the <strong>ErrorLog</strong>, and logs accesses using <strong>HyraxAccessLog</strong>. You can turn on debugging level logging by changing the log level to <strong>DEBUG</strong> for the software components you are interested in. All of the OPeNDAP code is in the &quot;opendap&quot; package and all of the THREDDS code is in the &quot;thredds&quot; package. Thus:</p>
<pre>
    &lt;logger name=&quot;thredds&quot;&gt;
        &lt;level value=&quot;Error&quot;/&gt;
        &lt;appender-ref ref=&quot;ErrorLog&quot;/&gt;
    &lt;/logger&gt;
	
    &lt;logger name=&quot;opendap&quot;&gt;
        &lt;level value=&quot;Error&quot;/&gt;
        &lt;appender-ref ref=&quot;ErrorLog&quot;/&gt;
    &lt;/logger&gt;
</pre>
<p>Will cause all log messages of <strong>ERROR</strong> level or higher to be sent to the error log.</p>
<p>This configuration:</p>
<pre>
    &lt;logger name=&quot;thredds&quot;&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;stdout&quot;/&gt;
    &lt;/logger&gt;
	
    &lt;logger name=&quot;DocServletAccess&quot;&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;stdout&quot;/&gt;
    &lt;/logger&gt;
</pre>
<p>Will cause all messages of level <strong>INFO</strong> or higher to be sent to <strong>stdout</strong>, which (in Tomcat) means that they will get stuck in the file <em>$TOMCAT_HOME/logs/catalina.out</em></p>
<p>This configuration: </p>
<pre>
    &lt;logger name=&quot;thredds&quot;&gt;
        &lt;level value=&quot;ALL&quot;/&gt;
        &lt;appender-ref ref=&quot;devNull&quot;/&gt;
    &lt;/logger&gt;
	
    &lt;logger name=&quot;opendap&quot;&gt;
        &lt;level value=&quot;ALL&quot;/&gt;
        &lt;appender-ref ref=&quot;devNull&quot;/&gt;
    &lt;/logger&gt;
</pre>


<p>Will cause all logging (except the hyrax access logging) to be discarded. </p>
<p>Hyrax access logging can be disabled in a similar manner:</p>
<pre>
    &lt;logger name=&quot;HyraxAccess&quot;&gt;
        &lt;level value=&quot;ALL&quot;/&gt;
        &lt;appender-ref ref=&quot;devNull&quot;/&gt;
    &lt;/logger&gt;
	
    &lt;logger name=&quot;DocServletAccess&quot;&gt;
        &lt;level value=&quot;ALL&quot;/&gt;
        &lt;appender-ref ref=&quot;devNull&quot;/&gt;
    &lt;/logger&gt;
</pre>
<p>Be sure to get in touch if you have further questions about the logging configuration. </p>
<hr size="1" noshade="noshade">
<h3><br /></h3></body>
</html>
